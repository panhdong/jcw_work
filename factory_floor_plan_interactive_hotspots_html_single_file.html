<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sơ đồ nhà máy – 工厂图</title>
  <style>
    :root{--bg:#0b0f14;--panel:#141a22;--muted:#8aa0b7;--accent:#5fb3ff;--ok:#28c76f;--warn:#ff9f43;--bad:#ea5455}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",ui-sans-serif,sans-serif;background:var(--bg);color:#e8eef5}
    .wrap{max-width:1400px;margin:0 auto;padding:12px}

    .board{position:relative;display:inline-block;background:#0f141b;border:1px solid #233041;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    .board img{display:block;max-width:100%;height:auto}

    /* Điểm (nếu dùng x_pct, y_pct) */
    .hotspot{position:absolute;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:999px;border:2px solid #fff;background:var(--accent);cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.45)}
    .hotspot.ok{background:var(--ok)}
    .hotspot.warn{background:var(--warn)}
    .hotspot.err{background:var(--bad)}
    .hotspot:focus{outline:3px solid rgba(255,255,255,.35)}

    /* Popover */
    .popover{position:absolute;min-width:280px;max-width:380px;background:var(--panel);border:1px solid #213041;border-radius:12px;box-shadow:0 16px 50px rgba(0,0,0,.55);padding:12px;z-index:30}
    .popover h3{margin:.2rem 0 .4rem;font-size:16px}
    .kv{display:grid;grid-template-columns:130px 1fr;gap:6px;font-size:13px;color:#cdd8e3}
    .kv div{padding:2px 0}
    .tag{display:inline-block;padding:.2rem .5rem;border-radius:999px;background:#1d2a39;border:1px solid #243548;color:#b7c6d8;font-size:11.5px}

    /* Toolbar */
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:10px 0 14px}
    .toolbar .btn{background:#172231;border:1px solid #223141;color:#d8e6f6;padding:8px 12px;border-radius:10px;cursor:pointer}
    .toolbar .btn:active{transform:translateY(1px)}
    .legend{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#121922;border:1px solid #223141;padding:6px 10px;border-radius:999px}
    .dot{width:10px;height:10px;border-radius:999px}
    .muted{color:var(--muted)}
    a{color:#b8dcff}

    /* Vùng chọn (overlay) – ẨN mặc định, chỉ hiện khi hover/focus */
    .overlay{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
    .zone{
      fill:rgba(95,179,255,0.01);   /* gần như trong suốt để vẫn bắt sự kiện */
      stroke:transparent;           /* ẩn viền */
      stroke-width:.6;
      pointer-events:auto;
      transition:fill .15s ease, stroke .15s ease, stroke-width .15s ease;
    }
    .zone:hover, .zone:focus{ fill:rgba(95,179,255,.22); stroke:#5fb3ff; stroke-width:1 }
    .zone.ok:hover,  .zone.ok:focus  { fill:rgba(40,199,111,.22);  stroke:#28c76f }
    .zone.warn:hover,.zone.warn:focus{ fill:rgba(255,159,67,.22);  stroke:#ff9f43 }
    .zone.err:hover, .zone.err:focus { fill:rgba(234,84,85,.22);   stroke:#ea5455 }
    .zone:focus{ outline:2px solid #fff }

    /* Hộp gợi ý toạ độ */
    .coord-hint{position:fixed;bottom:12px;right:12px;padding:8px 10px;background:#111722;border:1px solid #223141;border-radius:8px;font-size:12px;color:#c8d7ea}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="font-size:22px;margin:6px 2px 10px">Sơ đồ nhà máy – điểm thông tin tương tác</h1>
    <p class="muted" style="margin-top:0">Dữ liệu lấy trực tiếp từ Google Sheets. Di chuột/click vào <b>vùng</b> (hoặc chấm) để xem thông tin.</p>

    <div class="toolbar">
      <div class="legend">
        <span class="pill"><span class="dot" style="background:var(--ok)"></span> Hoạt Động</span>
        <span class="pill"><span class="dot" style="background:var(--warn)"></span> Cảnh Báo</span>
        <span class="pill"><span class="dot" style="background:var(--bad)"></span> Đã Đầy</span>
        <span class="pill"><span class="dot" style="background:var(--accent)"></span> Khác</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="refreshBtn" class="btn">Tải lại dữ liệu</button>
        <a class="btn" href="https://docs.google.com/spreadsheets/d/17YmmVafz78B5zWve0XrF7Y9Nj4nI7ovEn3TAwr8w8Bo/edit?gid=1329490609#gid=1329490609" target="_blank" rel="noopener">Mở Google Sheet</a>
        <label class="pill" style="cursor:pointer"><input id="editToggle" type="checkbox" style="margin-right:8px">Chế độ lấy toạ độ</label>
      </div>
    </div>

    <div id="board" class="board">
      <!-- Nền là SVG (đặt file So_do_nha_may_3.svg cùng thư mục với HTML) -->
      <img id="floorImg" src="So_do_nha_may_3.svg" alt="Factory floor plan" />
      <!-- Lớp overlay để vẽ vùng tương tác theo % -->
      <svg id="overlay" class="overlay" viewBox="0 0 100 100" preserveAspectRatio="none" aria-hidden="true"></svg>
      <!-- Hotspots (điểm) sẽ được render bằng JS nếu không có vùng -->
    </div>

    <div class="coord-hint" id="coordHint" style="display:none">
      Nhấp lên bản vẽ để lấy toạ độ (%). Dùng cho <b>x_pct</b>, <b>y_pct</b> hoặc tính <b>rect_*</b>/<b>polygon</b> trong Sheet.
      <div style="margin-top:6px" id="coordVal">x: –, y: –</div>
    </div>

    <p class="muted" style="margin-top:16px">Gợi ý: host file này trên GitHub Pages / Netlify / Vercel.</p>
  </div>

  <script>
    // ========= CẤU HÌNH ===========
    const SHEET_JSON_URL = "https://opensheet.elk.sh/17YmmVafz78B5zWve0XrF7Y9Nj4nI7ovEn3TAwr8w8Bo/Hotspots"; // JSON từ opensheet (tab Hotspots)
    const SHEET_WEB_URL  = "https://docs.google.com/spreadsheets/d/17YmmVafz78B5zWve0XrF7Y9Nj4nI7ovEn3TAwr8w8Bo/edit?gid=1329490609#gid=1329490609";

    // Cột đọc từ Sheet (không phân biệt hoa/thường):
    // name, name_cn, area_m2, usage, usage_cn, capacity, capacity_cn, status, status_cn,
    // x_pct, y_pct, rect_x_pct, rect_y_pct, rect_w_pct, rect_h_pct, polygon, notes, notes_cn, link

    const boardEl   = document.getElementById('board');
    const imgEl     = document.getElementById('floorImg');
    const overlayEl = document.getElementById('overlay');
    const refreshBtn= document.getElementById('refreshBtn');
    const editToggle= document.getElementById('editToggle');
    const coordHint = document.getElementById('coordHint');
    const coordVal  = document.getElementById('coordVal');

    let data = [];
    let popoverEl = null;
    let hoverCloseTimer = null;

    const normKey    = k => (k||'').toString().trim().toLowerCase();
    const escapeHtml = s => (s==null? '' : String(s)).replace(/[&<>"]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    const escapeAttr = s => escapeHtml(s).replace(/"/g,'%22');

    // === Fetch Google Sheet
    async function fetchSheet(){
      const res = await fetch(SHEET_JSON_URL, {cache:'no-store'});
      if(!res.ok) throw new Error('Không tải được dữ liệu: '+res.status);
      const rows = await res.json();
      return rows.map(r => {
        const o = {}; Object.keys(r).forEach(k=> o[normKey(k)] = r[k]);
        return {
          id: o.id||'',
          name: o.name||o["tên khu vực"]||o["ten khu vuc"]||o["ten"]||'',
          name_cn: o.name_cn || o["名称"] || '',
          area_m2: o.area_m2||o["diện tích"]||o["dien tich"]||'',
          usage: o.usage||o["công dụng"]||o["cong dung"]||'',
          usage_cn: o.usage_cn || o["用途"] || '',
          capacity: o.capacity||o["sức chứa"]||o["suc chua"]||'',
          capacity_cn: o.capacity_cn || o["容量"] || '',
          status: o.status||o["tình trạng"]||o["tinh trang"]||'',
          status_cn: o.status_cn || o["状态"] || '',
          x_pct: o.x_pct||o.x||'',
          y_pct: o.y_pct||o.y||'',
          rx: o.rect_x_pct||o.rx||'',
          ry: o.rect_y_pct||o.ry||'',
          rw: o.rect_w_pct||o.rw||'',
          rh: o.rect_h_pct||o.rh||'',
          poly: o.polygon||o.poly||'',
          notes: o.notes||o["ghi chú"]||o["ghi chu"]||'',
          notes_cn: o.notes_cn || o["备注"] || '',
          link: o.link||o["liên kết"]||o["lien ket"]||''
        };
      });
    }

    // === Map trạng thái Việt/Trung -> class màu
    function statusToClass(s){
      const vi = (s||'').toString().trim().toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,'');
      if (vi==='HOAT DONG' || s==='运行') return 'ok';
      if (vi==='CANH BAO'  || s==='警告') return 'warn';
      if (vi==='DA DAY'    || s==='已满') return 'err';
      return '';
    }

    // === Helpers song ngữ
    const zhStatusFallback = (vi=>{
      const u = (vi||'').toUpperCase().normalize("NFD").replace(/\p{Diacritic}/gu,'');
      if(u==='HOAT DONG') return '运行';
      if(u==='CANH BAO')  return '警告';
      if(u==='DA DAY')    return '已满';
      return '';
    });
    const bi = (vi, zh) => {
      const left = (vi??'').toString().trim();
      const right = (zh??'').toString().trim();
      if(left && right) return `${left} / ${right}`;
      return left || right || '—';
    };

    // === Hotspot (chấm)
    function createHotspot(item){
      if(!(item.x_pct && item.y_pct)) return null;
      const dot = document.createElement('button');
      dot.className = 'hotspot';
      dot.setAttribute('aria-label', item.name || 'Hotspot');
      const st = statusToClass(item.status); if (st) dot.classList.add(st);
      dot.style.left = (parseFloat(item.x_pct)||0) + '%';
      dot.style.top  = (parseFloat(item.y_pct)||0) + '%';
      const open = (ev)=>{ ev.stopPropagation(); openPopover(item, dot); };
      dot.addEventListener('mouseenter', open);
      dot.addEventListener('click', open);
      return dot;
    }

    // === Popover song ngữ
    function openPopover(item, anchor){
      closePopover();
      popoverEl = document.createElement('div');
      popoverEl.className = 'popover';

      const title = bi(item.name, item.name_cn);

      popoverEl.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;justify-content:space-between">
          <h3>${escapeHtml(title)}</h3>
          <span class="tag">${escapeHtml(bi(item.usage, item.usage_cn))}</span>
        </div>
        <div class="kv">
          <div>Diện tích (m²) / 面积</div><div>${escapeHtml(item.area_m2 || '—')}</div>
          <div>Công dụng / 用途</div><div>${escapeHtml(bi(item.usage, item.usage_cn))}</div>
          <div>Sức chứa / 容量</div><div>${escapeHtml(bi(item.capacity, item.capacity_cn))}</div>
          <div>Tình trạng / 状态</div><div>${escapeHtml(bi(item.status, item.status_cn || zhStatusFallback(item.status)))}</div>
          <div>Ghi chú / 备注</div><div>${escapeHtml(bi(item.notes, item.notes_cn))}</div>
          <div>Liên kết / 链接</div><div>${item.link? `<a href="${escapeAttr(item.link)}" target="_blank" rel="noopener">Mở / 打开</a>`:'—'}</div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px">
          ${SHEET_WEB_URL? `<a class="btn" href="${escapeAttr(SHEET_WEB_URL)}" target="_blank" rel="noopener">Chỉnh sửa trên Sheet / 在表格中编辑</a>`:''}
          <button class="btn" onclick="closePopover()">Đóng / 关闭</button>
        </div>`;
      boardEl.appendChild(popoverEl);

      const rectBoard = boardEl.getBoundingClientRect();
      const rectAnchor = anchor.getBoundingClientRect();
      const rect = { x: rectAnchor.left-rectBoard.left, y: rectAnchor.top-rectBoard.top, w: rectAnchor.width, h: rectAnchor.height };
      const x = rect.x + rect.w + 10;
      const y = rect.y - 4;
      popoverEl.style.left = Math.max(8, Math.min(x, rectBoard.width - 400)) + 'px';
      popoverEl.style.top  = Math.max(8, Math.min(y, rectBoard.height - 180)) + 'px';
    }

    function closePopover(){ if(popoverEl){ popoverEl.remove(); popoverEl = null; } }

    // === Vẽ vùng (rect / polygon)
    function clearZones(){ while(overlayEl.firstChild) overlayEl.removeChild(overlayEl.firstChild); }

    function createZoneRect(item){
      const must = ['rx','ry','rw','rh'];
      if(!must.every(k=> item[k]!=='' && item[k]!=null)) return null;
      const r = document.createElementNS('http://www.w3.org/2000/svg','rect');
      r.setAttribute('x', parseFloat(item.rx));
      r.setAttribute('y', parseFloat(item.ry));
      r.setAttribute('width',  parseFloat(item.rw));
      r.setAttribute('height', parseFloat(item.rh));
      r.setAttribute('tabindex','0');
      r.classList.add('zone');
      const st = statusToClass(item.status); if(st) r.classList.add(st);
      const open = (ev)=>{ ev.stopPropagation(); openPopover(item, r); };
      r.addEventListener('mouseenter', open);
      r.addEventListener('click', open);
      return r;
    }

    function parsePoly(str){
      if(!str) return null;
      const pts = String(str).replace(/;/g,' ').trim().split(/\s+/).map(p=> p.replace(/,/g,' ').trim()).filter(Boolean)
        .map(p=> p.split(/\s+/).map(Number)).filter(a=> a.length===2 && a.every(n=> !isNaN(n)));
      return pts.length>=3 ? pts : null;
    }

    function createZonePolygon(item){
      const pts = parsePoly(item.poly);
      if(!pts) return null;
      const pg = document.createElementNS('http://www.w3.org/2000/svg','polygon');
      pg.setAttribute('points', pts.map(([x,y])=> `${x},${y}`).join(' '));
      pg.setAttribute('tabindex','0');
      pg.classList.add('zone');
      const st = statusToClass(item.status); if(st) pg.classList.add(st);
      const open = (ev)=>{ ev.stopPropagation(); openPopover(item, pg); };
      pg.addEventListener('mouseenter', open);
      pg.addEventListener('click', open);
      return pg;
    }

    function render(){
      [...boardEl.querySelectorAll('.hotspot')].forEach(el=>el.remove());
      clearZones();
      data.forEach(item => {
        const pg = createZonePolygon(item);
        const rc = createZoneRect(item);
        if(pg) overlayEl.appendChild(pg);
        if(rc) overlayEl.appendChild(rc);
        if(!pg && !rc) {
          const dot = createHotspot(item);
          if(dot) boardEl.appendChild(dot);
        }
      });
    }

    // === Auto-close popover when not hovering any zone/hotspot ===
    function isInteractiveAt(clientX, clientY){
      const els = document.elementsFromPoint(clientX, clientY);
      return els.some(el =>
        (el.classList && (el.classList.contains('zone') || el.classList.contains('hotspot'))) ||
        el === popoverEl || (popoverEl && popoverEl.contains(el))
      );
    }
    boardEl.addEventListener('mousemove', (e)=>{
      if (isInteractiveAt(e.clientX, e.clientY)) {
        if (hoverCloseTimer) { clearTimeout(hoverCloseTimer); hoverCloseTimer = null; }
      } else {
        if (!hoverCloseTimer) {
          hoverCloseTimer = setTimeout(()=>{ closePopover(); hoverCloseTimer = null; }, 250);
        }
      }
    });
    boardEl.addEventListener('mouseleave', ()=>{
      closePopover();
      if(hoverCloseTimer){ clearTimeout(hoverCloseTimer); hoverCloseTimer = null; }
    });

    // === Load & interactions
    async function load(){
      try{ data = await fetchSheet(); render(); }
      catch(e){ console.error(e); alert('Lỗi tải dữ liệu. Mở DevTools để xem chi tiết.'); }
    }
    refreshBtn.addEventListener('click', load);
    document.addEventListener('click', (e)=>{ if(popoverEl && !popoverEl.contains(e.target)) closePopover(); });

    // Toạ độ
    editToggle.addEventListener('change', ()=>{ coordHint.style.display = editToggle.checked? 'block':'none'; boardEl.style.cursor = editToggle.checked? 'crosshair':'default'; });
    boardEl.addEventListener('mousemove', (e)=>{ if(!editToggle.checked) return; const p = pointPercent(e); coordVal.textContent = `x: ${p.x.toFixed(2)}%, y: ${p.y.toFixed(2)}%`; });
    boardEl.addEventListener('click', (e)=>{ if(!editToggle.checked) return; const p = pointPercent(e); const txt = `${p.x.toFixed(2)}, ${p.y.toFixed(2)}`; navigator.clipboard?.writeText(txt).catch(()=>{}); alert(`Toạ độ đã copy: ${txt}\n→ Dán vào cột x_pct, y_pct hoặc tính rect_*/polygon trong Google Sheet.`); });

    function pointPercent(e){
      const rect = imgEl.getBoundingClientRect();
      const x = ((e.clientX - rect.left) / rect.width) * 100;
      const y = ((e.clientY - rect.top)  / rect.height) * 100;
      return {x: Math.max(0, Math.min(100, x)), y: Math.max(0, Math.min(100, y))};
    }

    // Start
    load();
  </script>
</body>
</html>
